# jytian.it.com - 管理后台（IP白名单）
# 子域名: admin-portal.jytian.it.com
# 端口: 9443（自定义）

# 禁止HTTP访问
server {
    listen 80;
    server_name admin-portal.jytian.it.com;
    return 444;  # 直接关闭连接
}

# HTTPS管理后台
server {
    listen 9443 ssl http2;
    listen [::]:9443 ssl http2;
    server_name admin-portal.jytian.it.com;

    # SSL证书
    ssl_certificate /etc/letsencrypt/live/jytian.it.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/jytian.it.com/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/jytian.it.com/chain.pem;

    # SSL配置（最高级别）
    ssl_protocols TLSv1.3;  # 只允许TLS 1.3
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL_ADMIN:10m;

    # 安全头
    include /etc/nginx/snippets/security-headers.conf;

    # IP白名单（修改为你的IP）
    # 查询你的IP: curl ifconfig.me
    # allow 你的公网IP;
    # allow 你的备用IP;
    # deny all;

    # 临时允许所有（部署后务必修改！）
    # allow all;

    # 超严格限流
    limit_req_zone $binary_remote_addr zone=jytian_admin:10m rate=1r/s;
    limit_req zone=jytian_admin burst=2 nodelay;

    # 管理后台路由
    location / {
        proxy_pass http://127.0.0.1:5001;
        include /etc/nginx/snippets/proxy-params.conf;
    }

    # 禁止搜索引擎索引
    location = /robots.txt {
        return 200 "User-agent: *\nDisallow: /\n";
    }

    access_log /var/log/nginx/jytian-admin.log;
    error_log /var/log/nginx/jytian-admin-error.log warn;
}
