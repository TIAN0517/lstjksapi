# tiankai.it.com - 真实API（混淆子域名）
# 子域名: gateway.tiankai.it.com
# 端口: 7443（自定义）

# HTTP重定向
server {
    listen 80;
    server_name gateway.tiankai.it.com;
    return 301 https://$server_name:7443$request_uri;
}

# HTTPS真实API
server {
    listen 7443 ssl http2;
    listen [::]:7443 ssl http2;
    server_name gateway.tiankai.it.com;

    # SSL证书（通配符证书）
    ssl_certificate /etc/letsencrypt/live/tiankai.it.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tiankai.it.com/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/tiankai.it.com/chain.pem;

    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_stapling on;
    ssl_stapling_verify on;

    # 安全头
    include /etc/nginx/snippets/security-headers.conf;

    # 上传限制
    client_max_body_size 100M;

    # 连接数限制
    limit_conn_zone $binary_remote_addr zone=tiankai_api_conn:10m;
    limit_conn tiankai_api_conn 20;

    # API限流（超严格）
    limit_req_zone $binary_remote_addr zone=tiankai_real_api:10m rate=5r/s;
    limit_req_zone $binary_remote_addr zone=tiankai_real_login:10m rate=2r/s;
    limit_req_zone $binary_remote_addr zone=tiankai_real_register:10m rate=1r/s;

    # 健康检查
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # 登录API（超严格限流）
    location = /api/auth/login {
        limit_req zone=tiankai_real_login burst=3 nodelay;
        limit_req_status 429;

        # SQL注入防护
        if ($request_uri ~* "(union|select|insert|delete|drop|update|concat)") {
            return 403;
        }

        proxy_pass http://127.0.0.1:5000;
        include /etc/nginx/snippets/proxy-params.conf;

        access_log /var/log/nginx/tiankai-real-login.log;
    }

    # 注册API（超严格限流）
    location = /api/auth/register {
        limit_req zone=tiankai_real_register burst=2 nodelay;
        limit_req_status 429;

        proxy_pass http://127.0.0.1:5000;
        include /etc/nginx/snippets/proxy-params.conf;

        access_log /var/log/nginx/tiankai-real-register.log;
    }

    # 通用API路由
    location /api/ {
        limit_req zone=tiankai_real_api burst=10 nodelay;

        # SQL注入和XSS防护
        if ($request_uri ~* "(union|select|insert|delete|drop|update|concat|script|alert|eval)") {
            return 403;
        }

        proxy_pass http://127.0.0.1:5000;
        include /etc/nginx/snippets/proxy-params.conf;
    }

    # 禁止访问敏感文件
    location ~* \.(env|git|svn|htaccess|htpasswd|ini|log|sh|sql|conf|key|pem)$ {
        deny all;
        return 404;
    }

    access_log /var/log/nginx/tiankai-real-api.log;
    error_log /var/log/nginx/tiankai-real-api-error.log warn;
}
