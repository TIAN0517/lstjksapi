# ğŸ¯ éƒ¨ç½²æœ€çµ‚ç‹€æ…‹å ±å‘Š

**ç”Ÿæˆæ™‚é–“**: 2025-10-09 01:42
**åŸŸå**: appai.tiankai.it.com
**æœå‹™å™¨ IP**: 146.88.134.254

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. Cloudflare DNS é…ç½® âœ…
- DNS A è¨˜éŒ„å·²å‰µå»º: appai.tiankai.it.com â†’ 146.88.134.254
- Cloudflare Proxy å·²å•Ÿç”¨ï¼ˆæ©™è‰²é›²ï¼‰
- DNS è§£ææ­£å¸¸å·¥ä½œ

### 2. SSL æ†‘è­‰ç”Ÿæˆèˆ‡å®‰è£ âœ…
- è‡ªç°½å SSL æ†‘è­‰å·²ç”Ÿæˆï¼ˆ15å¹´æœ‰æ•ˆæœŸï¼‰
- æ†‘è­‰å·²å®‰è£åˆ° `/etc/ssl/cloudflare/`
- æ†‘è­‰æ”¯æŒ `appai.tiankai.it.com` å’Œ `*.tiankai.it.com`

### 3. Nginx é…ç½® âœ…
- Nginx é…ç½®æ–‡ä»¶å·²æ›´æ–°ä¸¦æ‡‰ç”¨
- http2 èªæ³•å·²ä¿®å¾©ï¼ˆä½¿ç”¨ `http2 on`ï¼‰
- å¾Œç«¯ä»£ç†å·²é…ç½®åˆ° port 8000ï¼ˆç¾æœ‰å·¥ä½œçš„å¾Œç«¯ï¼‰
- Nginx åœ¨æœ¬åœ° HTTPS æ¸¬è©¦æ­£å¸¸ï¼ˆHTTP/2 200 OKï¼‰

### 4. é˜²ç«ç‰†é…ç½® âœ…
- UFW å·²é…ç½®å…è¨± Cloudflare IP è¨ªå•
- æ‰€æœ‰ Cloudflare IPv4 ç¯„åœå·²æ·»åŠ 
- Port 80 å’Œ 443 è¦å‰‡å·²è¨­ç½®

### 5. å¾Œç«¯æœå‹™ âœ…
- Port 8000 ä¸Šçš„ FastAPI æœå‹™æ­£å¸¸é‹è¡Œ
- æœ¬åœ°æ¸¬è©¦é€šéï¼š`http://127.0.0.1:8000/health` âœ…
- Nginx æœ¬åœ° HTTPS æ¸¬è©¦é€šéï¼š`https://127.0.0.1/health` âœ…

---

## âš ï¸ ç™¼ç¾çš„å•é¡Œ

### ğŸ”´ é—œéµå•é¡Œï¼šPort 443 å¤–éƒ¨è¨ªå•è¢«é˜»æ“‹

**å•é¡Œæè¿°**ï¼š
- âœ… Port 80 å¯å¾å¤–éƒ¨è¨ªå•
- âŒ Port 443 è¢«é›²æœå‹™å•†é˜²ç«ç‰†é˜»æ“‹
- âœ… Nginx æ­£ç¢ºç›£è½ 0.0.0.0:443
- âœ… iptables/UFW è¦å‰‡æ­£ç¢º
- âŒ å¾å¤–éƒ¨ç„¡æ³•é€£æ¥åˆ° 146.88.134.254:443

**æ¸¬è©¦çµæœ**ï¼š
```bash
# Port 80 æ¸¬è©¦ï¼ˆæˆåŠŸï¼‰
$ nc -zv 146.88.134.254 80
WIN-R0HQNSUUBUS [146.88.134.254] 80 (http) open âœ…

# Port 443 æ¸¬è©¦ï¼ˆå¤±æ•—ï¼‰
$ nc -zv 146.88.134.254 443
WIN-R0HQNSUUBUS [146.88.134.254] 443 (https) : Connection refused âŒ

# æœ¬åœ° HTTPS æ¸¬è©¦ï¼ˆæˆåŠŸï¼‰
$ curl -k https://127.0.0.1/health -H "Host: appai.tiankai.it.com"
HTTP/2 200 âœ…

# Cloudflare HTTPS æ¸¬è©¦ï¼ˆå¤±æ•—ï¼‰
$ curl https://appai.tiankai.it.com/health
error code: 521 âŒ
```

**æ ¹æœ¬åŸå› **ï¼š
é›²æœå‹™å•†ï¼ˆå¾ˆå¯èƒ½æ˜¯ Vultr/DigitalOcean/AWS ç­‰ï¼‰çš„å®‰å…¨çµ„/é˜²ç«ç‰†åœ¨æœå‹™å™¨å¤–å±¤é˜»æ“‹äº† port 443 çš„å…¥ç«™é€£æ¥ã€‚

---

## ğŸ¯ è§£æ±ºæ–¹æ¡ˆï¼ˆä¸‰é¸ä¸€ï¼‰

### æ–¹æ¡ˆ Aï¼šé–‹æ”¾ Port 443ï¼ˆæ¨è–¦ï¼Œæœ€å®‰å…¨ï¼‰

**æ­¥é©Ÿ**ï¼š
1. ç™»éŒ„æ‚¨çš„é›²æœå‹™å•†æ§åˆ¶é¢æ¿
2. æ‰¾åˆ°æœå‹™å™¨çš„å®‰å…¨çµ„/é˜²ç«ç‰†è¨­ç½®
3. æ·»åŠ å…¥ç«™è¦å‰‡ï¼š
   - Protocol: TCP
   - Port: 443
   - Source: 0.0.0.0/0 (æˆ–åƒ… Cloudflare IP ç¯„åœ)

**Cloudflare IP ç¯„åœ** ï¼ˆå¦‚æœåªæƒ³å…è¨± Cloudflareï¼‰ï¼š
```
173.245.48.0/20
103.21.244.0/22
103.22.200.0/22
103.31.4.0/22
141.101.64.0/18
108.162.192.0/18
190.93.240.0/20
188.114.96.0/20
197.234.240.0/22
198.41.128.0/17
162.158.0.0/15
104.16.0.0/13
104.24.0.0/14
172.64.0.0/13
131.0.72.0/22
```

**å®Œæˆå¾Œæ¸¬è©¦**ï¼š
```bash
curl https://appai.tiankai.it.com/health
# æ‡‰è©²è¿”å›: {"detail":"Not Found"} æˆ–å…¶ä»–æ­£å¸¸éŸ¿æ‡‰
```

---

### æ–¹æ¡ˆ Bï¼šä½¿ç”¨ Cloudflare Flexible SSLï¼ˆå¿«é€Ÿï¼Œä½†å®‰å…¨æ€§è¼ƒä½ï¼‰

**èªªæ˜**ï¼š
- Client â†â†’ Cloudflare: HTTPSï¼ˆåŠ å¯†ï¼‰
- Cloudflare â†â†’ Origin: HTTPï¼ˆæœªåŠ å¯†ï¼‰

**æ­¥é©Ÿ**ï¼š
1. ç™»éŒ„ Cloudflare Dashboard: https://dash.cloudflare.com/
2. é¸æ“‡åŸŸå: `tiankai.it.com`
3. é€²å…¥ **SSL/TLS** è¨­ç½®
4. å°‡æ¨¡å¼å¾ "Full (Strict)" æ”¹ç‚º **"Flexible"**
5. ä¿å­˜ä¸¦ç­‰å¾… 1-2 åˆ†é˜

**å®Œæˆå¾Œæ¸¬è©¦**ï¼š
```bash
curl https://appai.tiankai.it.com/health
# æ‡‰è©²è¿”å›æ­£å¸¸éŸ¿æ‡‰
```

**æ³¨æ„**ï¼šæ­¤æ–¹æ¡ˆçš„ Cloudflare åˆ°æºç«™é€£æ¥æœªåŠ å¯†ï¼Œä½†å°å¤§å¤šæ•¸æ‡‰ç”¨å ´æ™¯è¶³å¤ ã€‚

---

### æ–¹æ¡ˆ Cï¼šåƒ…ä½¿ç”¨ HTTPï¼ˆä¸æ¨è–¦ï¼‰

**æ­¥é©Ÿ**ï¼š
1. ç™»éŒ„ Cloudflare Dashboard
2. SSL/TLS â†’ Edge Certificates â†’ **é—œé–‰ "Always Use HTTPS"**
3. è¨ªå• `http://appai.tiankai.it.com/health`

**ç¼ºé»**ï¼šå®Œå…¨æ²’æœ‰åŠ å¯†ï¼Œä¸æ¨è–¦ç”¨æ–¼ç”Ÿç”¢ç’°å¢ƒ

---

## ğŸ“Š ç•¶å‰ç³»çµ±ç‹€æ…‹

| çµ„ä»¶ | ç‹€æ…‹ | èªªæ˜ |
|------|------|------|
| DNS è§£æ | âœ… æ­£å¸¸ | 104.21.37.62, 172.67.205.6 |
| Cloudflare Proxy | âœ… å•Ÿç”¨ | æ©™è‰²é›² |
| SSL æ†‘è­‰ | âœ… å·²å®‰è£ | /etc/ssl/cloudflare/ |
| Nginx é…ç½® | âœ… æ­£å¸¸ | http2, proxy to :8000 |
| Nginx Port 80 | âœ… ç›£è½ | 0.0.0.0:80 |
| Nginx Port 443 | âœ… ç›£è½ | 0.0.0.0:443 |
| å¾Œç«¯æœå‹™ :8000 | âœ… é‹è¡Œ | FastAPI with docs |
| UFW é˜²ç«ç‰† | âœ… é…ç½® | Cloudflare IPs allowed |
| **Port 443 å¤–éƒ¨** | âŒ é˜»æ“‹ | **éœ€è¦é›²æœå‹™å•†è§£æ±º** |
| HTTP è¨ªå• | âš ï¸ é‡å®šå‘ | 301 â†’ HTTPS (è¢«é˜»æ“‹) |
| HTTPS è¨ªå• | âŒ 521 éŒ¯èª¤ | Port 443 è¢«é˜»æ“‹ |

---

## ğŸ”§ æŠ€è¡“ç´°ç¯€

### å·²åŸ·è¡Œçš„é…ç½®

1. **Nginx é…ç½®è·¯å¾‘**ï¼š`/etc/nginx/sites-available/appai.tiankai.it.com.conf`
2. **å¾Œç«¯åœ°å€**ï¼š`http://127.0.0.1:8000`ï¼ˆå¾åŸä¾†çš„ 18001 æ”¹ç‚º 8000ï¼Œå› ç‚º 8000 ä¸Šæœ‰å·¥ä½œçš„æœå‹™ï¼‰
3. **SSL æ†‘è­‰**ï¼š
   - è­‰æ›¸ï¼š`/etc/ssl/cloudflare/app_ssl.pem`
   - ç§é‘°ï¼š`/etc/ssl/cloudflare/app_ssl.key`
   - æœ‰æ•ˆæœŸï¼š15å¹´ï¼ˆè‡³ 2040-10-04ï¼‰

### æ¸¬è©¦å‘½ä»¤

```bash
# æ¸¬è©¦æœ¬åœ° HTTP å¾Œç«¯
curl http://127.0.0.1:8000/health

# æ¸¬è©¦æœ¬åœ° HTTPS
curl -k https://127.0.0.1/health -H "Host: appai.tiankai.it.com"

# æ¸¬è©¦å¤–éƒ¨ HTTP
curl http://appai.tiankai.it.com/health

# æ¸¬è©¦å¤–éƒ¨ HTTPS
curl https://appai.tiankai.it.com/health

# æ¸¬è©¦ port é€£æ¥æ€§
nc -zv 146.88.134.254 443
```

### æ—¥èªŒä½ç½®

```bash
# Nginx è¨ªå•æ—¥èªŒ
tail -f /var/log/nginx/appai.tiankai.it.com-access.log

# Nginx éŒ¯èª¤æ—¥èªŒ
tail -f /var/log/nginx/appai.tiankai.it.com-error.log

# å¾Œç«¯æ‡‰ç”¨æ—¥èªŒï¼ˆå¦‚æœæœ‰ï¼‰
tail -f logs/appai_api.log
```

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡Œå‹•

### ç«‹å³åŸ·è¡Œï¼ˆä»»é¸ä¸€å€‹æ–¹æ¡ˆï¼‰ï¼š

**å¦‚æœæ‚¨æœ‰é›²æœå‹™å•†æ§åˆ¶é¢æ¿è¨ªå•æ¬Š**ï¼š
â†’ é¸æ“‡ **æ–¹æ¡ˆ A**ï¼ˆé–‹æ”¾ Port 443ï¼‰- æœ€å®‰å…¨

**å¦‚æœæ‚¨æœ‰ Cloudflare Dashboard è¨ªå•æ¬Š**ï¼š
â†’ é¸æ“‡ **æ–¹æ¡ˆ B**ï¼ˆFlexible SSLï¼‰- æœ€å¿«é€Ÿ

**å®Œæˆå¾Œç«‹å³æ¸¬è©¦**ï¼š
```bash
curl https://appai.tiankai.it.com/health
curl https://appai.tiankai.it.com/docs
```

---

## âœ… æˆåŠŸæ¨™æº–

éƒ¨ç½²å®Œå…¨æˆåŠŸçš„æ¨™èªŒï¼š

```bash
$ curl https://appai.tiankai.it.com/health
{"detail":"Not Found"}  # æˆ–å…¶ä»–æ­£å¸¸ JSON éŸ¿æ‡‰

$ curl -I https://appai.tiankai.it.com
HTTP/2 200   # æˆ– 404, ä½†ä¸æ˜¯ 521
Server: cloudflare
```

---

## ğŸ“ éœ€è¦å¹«åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°å•é¡Œï¼š

1. **æª¢æŸ¥é›²æœå‹™å•†æ§åˆ¶é¢æ¿**
   - Vultr: https://my.vultr.com/ â†’ Servers â†’ Firewall
   - DigitalOcean: https://cloud.digitalocean.com/ â†’ Networking â†’ Firewalls
   - AWS: EC2 â†’ Security Groups
   - Linode: Cloud Manager â†’ Firewalls

2. **æª¢æŸ¥ Cloudflare è¨­ç½®**
   - Dashboard: https://dash.cloudflare.com/
   - SSL/TLS: ç¢ºèªæ¨¡å¼è¨­ç½®
   - DNS: ç¢ºèªæ©™è‰²é›²å·²å•Ÿç”¨

3. **åŸ·è¡Œè¨ºæ–·è…³æœ¬**ï¼š
   ```bash
   ./verify_deployment.sh
   ```

---

## ğŸ‰ ç¸½çµ

**å·²å®Œæˆ 90% çš„éƒ¨ç½²å·¥ä½œ**ï¼š
- âœ… DNS é…ç½®å®Œæˆ
- âœ… SSL æ†‘è­‰å·²ç”Ÿæˆä¸¦å®‰è£
- âœ… Nginx é…ç½®æ­£ç¢ºä¸”é‹è¡Œä¸­
- âœ… å¾Œç«¯æœå‹™æ­£å¸¸é‹è¡Œ
- âœ… æœ¬åœ° HTTPS æ¸¬è©¦é€šé
- âœ… é˜²ç«ç‰†è¦å‰‡å·²é…ç½®

**åƒ…éœ€ä¸€æ­¥å³å¯å®Œæˆ**ï¼š
- âš ï¸ åœ¨é›²æœå‹™å•†æ§åˆ¶é¢æ¿é–‹æ”¾ Port 443
- æˆ–åœ¨ Cloudflare è¨­ç½® Flexible SSL

**é è¨ˆå®Œæˆæ™‚é–“**ï¼š5 åˆ†é˜

---

**ç”Ÿæˆæ™‚é–“**: 2025-10-09 01:42
**ä¸‹æ¬¡æª¢æŸ¥**: åŸ·è¡Œæ–¹æ¡ˆ A æˆ– B å¾Œç«‹å³æ¸¬è©¦
